<h2 class="title">Manga List</h2>

<button class="btn btn--ghost" (click)="openAddForm()">+ Add Manga</button>

<div *ngIf="showAddForm" class="panel panel--form">
  <div class="panel__header">
    <h3 class="panel__title">
      {{ isEditing ? 'Edit Manga' : 'Add Manga' }}
    </h3>
    <button type="button" class="panel__close" (click)="cancelAdd()">Ã—</button>
  </div>

  <form class="form" (ngSubmit)="isEditing ? updateManga() : createManga()">
    <label class="form__field">
      <span class="form__label">Title</span>
      <input class="form__input" [(ngModel)]="newManga.title" name="title" required />
    </label>

    <label class="form__field">
      <span class="form__label">Author</span>
      <input class="form__input" [(ngModel)]="newManga.author" name="author" />
    </label>

    <label class="form__field">
      <span class="form__label">Total Volumes</span>
      <input
        class="form__input"
        type="number"
        [(ngModel)]="newManga.totalVolumes"
        name="totalVolumes"
        min="1"
      />
    </label>

    <label class="form__field">
      <span class="form__label">Cover URL</span>
      <input class="form__input" [(ngModel)]="newManga.coverUrl" name="coverUrl" />
    </label>

    <div class="form__actions">
      <button type="submit" class="btn btn--primary">Save</button>
      <button type="button" class="btn btn--ghost" (click)="cancelAdd()">Cancel</button>
    </div>
  </form>
</div>

<label class="search">
  <input
    class="search__input"
    type="text"
    placeholder="Search by titleâ€¦"
    [(ngModel)]="query"
    (ngModelChange)="onQueryChange($event)"
    aria-label="Search manga"
  />
  <button
    *ngIf="query"
    type="button"
    class="search__clear"
    (click)="query = ''; onQueryChange('')"
    aria-label="Clear search"
  >
    Ã—
  </button>
</label>

<div *ngIf="isLoading" class="muted">Loadingâ€¦</div>
<div *ngIf="!isLoading && mangas.length === 0" class="muted">No manga found.</div>

<div *ngIf="!isLoading && mangas.length > 0" class="panel">
  <ul class="mlist">
    <li *ngFor="let m of mangas; trackBy: trackById" class="mlist__row">
      <a [routerLink]="['/manga', m.id]" class="mlist__link">
        <img
          class="mlist__cover"
          [src]="m.coverUrl || 'manga-placeholder.svg'"
          [alt]="m.title"
          (error)="onImgError($event)"
        />
        <div class="mlist__meta">
          <div class="mlist__title">{{ m.title }}</div>
          <div class="mlist__author">{{ m.author }}</div>
        </div>
      </a>

      <div class="mlist__actions">
        <button
          type="button"
          class="mlist__menu-toggle"
          (click)="toggleMenu(m.id, $event)"
          aria-label="Open actions menu"
        >
          &#8942;
        </button>

        <div class="mlist__menu" *ngIf="openMenuId === m.id">
          <button type="button" class="mlist__menu-item" (click)="onEdit(m, $event)">
            <span class="mlist__menu-icon">âœŽ</span>
            <span class="mlist__menu-label">Edit</span>
          </button>

          <button
            type="button"
            class="mlist__menu-item mlist__menu-item--danger"
            (click)="openDeleteModal(m, $event)"
          >
            <span class="mlist__menu-icon">ðŸ—‘</span>
            <span class="mlist__menu-label">Delete</span>
          </button>
        </div>
      </div>
    </li>
  </ul>
</div>
<div class="modal-backdrop" *ngIf="deleteConfirmVisible" (click)="closeDeleteModal()"></div>

<div class="modal" *ngIf="deleteConfirmVisible" (click)="closeDeleteModal()">
  <div class="modal__content" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h3 class="modal__title">Delete manga</h3>
    </div>

    <div class="modal__body">
      <p>
        Are you sure you want to delete
        <strong>{{ mangaToDelete?.title }}</strong
        >?
      </p>
    </div>

    <div class="modal__footer">
      <button type="button" class="btn btn--ghost" (click)="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn btn--danger" (click)="confirmDelete()">Delete</button>
    </div>
  </div>
</div>
